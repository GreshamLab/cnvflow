---
title: "CytoexploreR Vignette for Gresham Lab"
author: "Julie Chuong"
output: html_notebook
---

This is notebook is to show you how to use the package CytoexploreR to analyze flow cytometry data from the Cytek Aurora. 

Install CytoExplorer package and requirements (Skip if already installed)
```{r}
library(BiocManager)
install.packages("cytolib", "flowCore", "flowWorkspace", "openCyto")
```

Install CytoExploreR from GitHub (Skip is already installed)
```{r}
library(devtools)
devtools::install_github("DillonHammill/CytoExploreR")
```

Load required packages
```{r}
library(CytoExploreR)
library(tidyverse)
library(ggridges)
```

## Vignette Dataset

Three replicate populations of the GAP1 CNV reporter strain, in which a mCitrine gene was inserted upstream of the GAP1 promoter and coding sequence, was experimentally evolved in chemostats in glutamine-limited media for 200 generations. Additionally, there was one population each of 3 control strains: zero copy 'unstained' control (DGY1) that has no mCitrine, one copy control (DGY500) in which the mCitrine gene was inserted in neutral locus *WHAT LOCUS?* that doesn't undergo copy number variation under glutamine-limited growth, and two copy control (DGY1315) containing two inserted copies of mCitrine in neutral loci. Samples of every population were taken every 8, 13, 8 generations (Mon, Wed, Fri). In each sample, 100,000 events were measured for mCitrine fluorescence (excitation wavelength = 516, emission wavelength = 529 ) via the B2-A channel, forward scatter, and side scatter. In total, there are six populations and 19 timepoints. 

### Set working directory and get list of subdirectories
Place your FCS files in a directory. Multiple subdirectories containing FCS files are OK. 

*Note 1* You can only load in one folder's worth of FCS files at a time. In this vignette, we have organized one timepoint's worth of FCS files per subdirectory. There is one FSC file per population. Additionally, we have one subdirectory with three timepoints' worth of FCS files inside for drawing gates (because timepoint one data were not sufficient to draw good gates, see STEP __). In total, there are 20 subdirectories, with an FSC file per population, for which there are six. 

*Note 2* The subdirectories are uniquely named like this TimepointNumber_ExperimentName_SampleDate_generation_Initials. Therefore out subdirectory names contain important  metadata. 

*Note 3* You should not manually rename your FCS files after exporting it from the Cytek. In other words, files should have their original names from the machine. "Renaming the files manually is not recommended as it does not update the associated keywords contained in the FCS files" (Source: https://github.com/DillonHammill/CytoExploreR/issues/85). If files need to renamed, do so on on the Cytek software and re-export the FCS files.  

```{r setup, include=FALSE, echo=FALSE}
require("knitr")
opts_knit$set(root.dir = "/Volumes/GoogleDrive/My Drive/greshamlab/projects/EE_GAP1_ArchMuts_Summer2021/data/vignette_data_workingcopy")
```

```{r}
folders = list.dirs()[-1]
```

### Version name
Choose a name to be used for all output files including the gating template and associated flow data and graphs. Since we will be using data from timepoints 1, 2, and 4 to draw gates, we choose a name to reflect that 
```{r}
version_name = "timepoints-01-02-04_v1"
getwd()
```

### STEP 1: Generate experiment details file.
A .csv file that contains the list of .fcs files in the directory and the associated metadata for each sample.

A custom sample sheet is imported to the function. 
This function uses regex (regular expressions) to extract metadata from the subdirectory name and sample sheet to generate an experiment details file for each timepoint subdirectory and places the file inside the corresponding subdirectory. We sampled cells from a 96 well plate so our metadata contains well number. 
```{r}
make_exp_details = function(folder_name, samplesheet) {
  pref = folder_name %>% str_extract("([0-9])+_EE_GAP1_ArchMuts_2021")
  generation = folder_name %>% str_extract("[g]\\d+") %>% str_remove("g")

  files = as_tibble(list.files(paste0(folder_name))) %>%
    separate(value, into = c("well", "samp"), sep = " ", remove = F) %>%
    mutate(well = str_extract(well, "([A-Z])([0-9]){1,2}$")) %>%
    mutate(samp = str_remove(samp, ".fcs")) %>%
    mutate(sample = case_when(str_detect(value, "Unstained") ~ "ctrl0",
                              str_detect(value, "DGY500") ~ "ctrl1",
                              str_detect(value, "DGY1315") ~ "ctrl2",
                              TRUE ~ samp)) %>%
    select(value,sample) %>%
    rename(name = value) %>%
    filter(!is.na(sample))

  all = files %>%
    left_join(read_csv(paste0("./",samplesheet)), by = c("sample" = "Sample name")) %>%
    mutate(generation = as.numeric(generation))

  write_csv(all, file = paste0(folder_name,"/",pref,"_experiment_details.csv"))

}
```

Run the function on all subdirectories except the subdirectory we will use for gating which is the first directory. Only needs to be run once to create the experimental details .csv files. The samplesheet should be sitting in the working directory, not the subdirectories. 
```{r}
map(folders[-1], make_exp_details, samplesheet = "EE_GAP1_ArchMuts_2021.csv")
```

Next, copy the experiment details files from timepoints 1, 2, 4 and place them in the gating subdirectory. Only needs to be run once. You can do this in the terminal or manually using your file GUI/Finder
```{bash}
cd ~/Google\ Drive/My\ Drive/greshamlab/projects/EE_GAP1_ArchMuts_Summer2021/data/vignette_data_workingcopy

scp ./01_EE_GAP1_ArchMuts_2021_061621_g8_GA/01_EE_GAP1_ArchMuts_2021_experiment_details.csv 01_02_04_EE_GAP1_ArchMuts_2021/ 

scp ./02_EE_GAP1_ArchMuts_2021_062121_g21_TD/02_EE_GAP1_ArchMuts_2021_experiment_details.csv 01_02_04_EE_GAP1_ArchMuts_2021/ 

scp ./04_EE_GAP1_ArchMuts_2021_062521_g37_IS/04_EE_GAP1_ArchMuts_2021_experiment_details.csv 01_02_04_EE_GAP1_ArchMuts_2021/
```

Add a new chunk by clicking the *Insert Chunk* button on the toolbar or by pressing *Cmd+Option+I*.
```{r}
load
```


When you save the notebook, an HTML file containing the code and output will be saved alongside it (click the *Preview* button or press *Cmd+Shift+K* to preview the HTML file). 

The preview shows you a rendered HTML copy of the contents of the editor. Consequently, unlike *Knit*, *Preview* does not run any R code chunks. Instead, the output of the chunk when it was last run in the editor is displayed.

